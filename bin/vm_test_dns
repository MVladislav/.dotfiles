#!/usr/bin/env bash
set -euo pipefail
trap 'echo "ERROR: Unexpected error on line $LINENO (command: $BASH_COMMAND)." >&2' ERR

command -v dig >/dev/null || {
  echo "dig not found"
  exit 1
}

# -----------------------------
# DNS providers
# - home → local resolver
# - std → default when no special behavior
# - alt → secondary / alternative endpoint
# - sec → filtered / secure
# - unf → unfiltered
# -----------------------------
PROVIDERSV4_HOME="${PROVIDERSV4_HOME:-"192.168.1.1"}#home"
PROVIDERSV6_HOME="${PROVIDERSV6_HOME:-"fd00:affe:affe:1::1"}#home-v6"
PROVIDERSV4=(
  "$PROVIDERSV4_HOME"

  # https://quad9.net/service/service-addresses-and-features
  "9.9.9.9#quad9-sec-std"
  "149.112.112.112#quad9-sec-alt"
  "9.9.9.10#quad9-unf-std"
  "149.112.112.10#quad9-unf-alt"

  # https://developers.cloudflare.com/1.1.1.1/ip-addresses
  "1.1.1.2#cloudflare-sec-std"
  "1.0.0.2#cloudflare-sec-alt"
  "1.1.1.1#cloudflare-unf-std"
  "1.0.0.1#cloudflare-unf-alt"

  # https://developers.google.com/speed/public-dns/docs/using
  "8.8.8.8#google-std"
  "8.8.4.4#google-alt"

  # https://vercara.digicert.com/ultra-dns-public
  "156.154.70.2#vercara-sec-std"
  "156.154.70.3#vercara-sec-alt"
  "64.6.64.6#vercara-unf-std"
  "64.6.65.6#vercara-unf-alt"

  # https://adguard-dns.io/kb/general/dns-providers
  "94.140.14.14#adguard-sec-std"
  "176.103.15.15#adguard-sec-alt"
  "94.140.14.140#adguard-unf-std"
  "94.140.14.141#adguard-unf-alt"

  # "208.67.222.222#opendns-std"
  # "208.67.220.220#opendns-alt"
  # "4.2.2.1#level3-std"
  # "4.2.2.5#level3-alt"
  # "45.90.28.202#nextdns"
  # "8.26.56.26#comodo"
  # "199.85.126.20#norton"
  # "77.88.8.7#yandex"
  # "80.80.80.80#freenom"
  # "185.228.168.168#cleanbrowsing"
)
PROVIDERSV6=(
  "$PROVIDERSV6_HOME"

  "2620:fe::9#quad9-sec-std-v6"
  "2620:fe::fe#quad9-sec-alt-v6"
  "2620:fe::10#quad9-unf-std-v6"
  "2620:fe::fe:10#quad9-unf-alt-v6"

  "2606:4700:4700::1112#cloudflare-sec-std-v6"
  "2606:4700:4700::1002#cloudflare-sec-alt-v6"
  "2606:4700:4700::1111#cloudflare-unf-std-v6"
  "2606:4700:4700::1001#cloudflare-unf-alt-v6"

  "2001:4860:4860::8888#google-std-v6"
  "2001:4860:4860::8844#google-alt-v6"

  "2610:a1:1018::2#vercara-sec-std-v6"
  "2610:a1:1018::3#vercara-sec-alt-v6"
  "2620:74:1b::1:1#vercara-unf-std-v6"
  "2620:74:1c::2:2#vercara-unf-alt-v6"

  "2a10:50c0::ad1:ff#adguard-sec-std-v6"
  "2a10:50c0::ad2:ff#adguard-sec-alt-v6"
  "92a10:50c0::1:ff#adguard-unf-std-v6"
  "2a10:50c0::2:ff#adguard-unf-alt-v6"

  # "2620:119:35::35#opendns-v6"
  # "2a02:6b8::feed:0ff#yandex-v6"
  # "2a0d:2a00:1::1#cleanbrowsing-v6"
)

# -----------------------------
# Domains to test
# -----------------------------
DOMAINS=(
  ubuntu.com github.com reddit.com
  wikipedia.org youtube.com amazon.com
  # example.com google.com google.de
  # chatgpt.com pinterest.com x.com
  # whatsapp.com facebook.com instagram.com
)

TRIES=5
COL_W=42
NAME_W=20
WARN_LATENCY=50 # highlight if warm avg > X ms
WARN_SUCCESS=95 # highlight if success < X %

rand_name() { printf "%s.%s" "$(date +%s%N)" "$1"; }

# -----------------------------
# Initialize summary arrays
# -----------------------------
declare -A PROVIDER_TOTAL_MS PROVIDER_TOTAL_OK PROVIDER_TOTAL_Q
declare -A PROVIDER_COLD_MS PROVIDER_COLD_OK
declare -A PROVIDER_TOTAL_SERVFAIL PROVIDER_TOTAL_NX PROVIDER_TOTAL_TIMEOUT

echo "# DNS Test"

# -----------------------------
# Detect IPv6 availability
# -----------------------------
echo
echo "## Infos"
echo
echo "- Naming scheme Variants:"
echo "  - home → local resolver"
echo "  - std → default when no special behavior"
echo "  - alt → secondary / alternative endpoint"
echo "  - sec → filtered / secure"
echo "  - unf → unfiltered"
echo "- Checking for IPv6 interfaces..."
if ip a | grep -q 'inet6'; then
  if dig -6 @2620:fe::9 example.com +tries=1 +retry=0 +timeout=3 >/dev/null 2>&1; then
    echo "  - IPv6 interface and connectivity detected, adding IPv6 DNS providers..."
    PROVIDERS_TO_TEST=("${PROVIDERSV4[@]}" "${PROVIDERSV6[@]}")
  else
    echo "  - IPv6 interface detected, but no connectivity. Using IPv4 only."
    PROVIDERS_TO_TEST=("${PROVIDERSV4[@]}")
  fi
else
  echo "  - No IPv6 interface detected. Using IPv4 only."
  PROVIDERS_TO_TEST=("${PROVIDERSV4[@]}")
fi

echo "- Used Home DNS Resolver(s):"
echo "  - IPv4(${PROVIDERSV4_HOME##*#}): ${PROVIDERSV4_HOME%%#*}"
if [[ " ${PROVIDERS_TO_TEST[*]} " == *"${PROVIDERSV6_HOME}"* ]]; then
  echo "  - IPv6(${PROVIDERSV6_HOME##*#}): ${PROVIDERSV6_HOME%%#*}"
fi

# -----------------------------
# Check reachability before main loop
# -----------------------------
echo "- Checking for providers not reachable (will be skipped)..."
SKIPPED_PROVIDERS=()
REACHABLE_PROVIDERS=()
for p in "${PROVIDERS_TO_TEST[@]}"; do
  p_ip=${p%%#*}
  p_name=${p##*#}
  if dig @"$p_ip" example.com +time=1 +tries=1 >/dev/null 2>&1; then
    REACHABLE_PROVIDERS+=("$p")
  else
    SKIPPED_PROVIDERS+=("$p_name ($p_ip)")
  fi
done
PROVIDERS_TO_TEST=("${REACHABLE_PROVIDERS[@]}")
if [ "${#SKIPPED_PROVIDERS[@]}" -gt 0 ]; then
  for p in "${SKIPPED_PROVIDERS[@]}"; do
    echo "  - $p"
  done
fi

# -----------------------------
# Header
# -----------------------------
echo
echo "## Measured Latency"
echo
printf "| %-${NAME_W}s |" ""
for d in "${DOMAINS[@]}"; do
  printf " %-${COL_W}s |" "${d%%.*}"
done
echo
printf "|%*s|" $((NAME_W + 2)) "" | tr ' ' '-'
for _ in "${DOMAINS[@]}"; do
  printf "%*s|" $((COL_W + 2)) "" | tr ' ' '-'
done
echo

# -----------------------------
# Main loop: measure latency
# -----------------------------
for p in "${PROVIDERS_TO_TEST[@]}"; do
  p_ip=${p%%#*}
  p_name=${p##*#}

  PROVIDER_TOTAL_MS[$p_name]=0
  PROVIDER_TOTAL_OK[$p_name]=0
  PROVIDER_TOTAL_Q[$p_name]=$((TRIES * ${#DOMAINS[@]}))
  PROVIDER_COLD_MS[$p_name]=0
  PROVIDER_COLD_OK[$p_name]=0
  PROVIDER_TOTAL_SERVFAIL[$p_name]=0
  PROVIDER_TOTAL_NX[$p_name]=0
  PROVIDER_TOTAL_TIMEOUT[$p_name]=0

  printf "| %-${NAME_W}s |" "$p_name"
  for d in "${DOMAINS[@]}"; do
    total=0 min=999999 max=0
    ok=0 servfail=0 nxdomain=0 timeout=0

    # ---- cold query (cache miss)
    cold=$(rand_name "$d")
    cold_out=$(dig @"$p_ip" "$cold" +stats +tries=1 +retry=0 +timeout=3 2>/dev/null || true)
    cold_ms=$(awk '/Query time:/ {print $4}' <<<"$cold_out")
    cold_ms=${cold_ms:-X}
    if [ "$cold_ms" != "X" ]; then
      PROVIDER_COLD_MS[$p_name]=$((PROVIDER_COLD_MS[$p_name] + cold_ms))
      PROVIDER_COLD_OK[$p_name]=$((PROVIDER_COLD_OK[$p_name] + 1))
    fi

    # ---- warm queries
    for ((i = 1; i <= TRIES; i++)); do
      out=$(dig @"$p_ip" "$d" +stats +tries=1 +retry=0 +timeout=3 2>/dev/null || true)
      stat=$(awk '/status:/ {gsub(/,/, "", $6); print $6}' <<<"$out")
      qtime=$(awk '/Query time:/ {print $4}' <<<"$out")
      qtime=${qtime:-0}

      case "$stat" in
      NOERROR)
        ok=$((ok + 1))
        total=$((total + qtime))
        [ "$qtime" -lt "$min" ] && min=$qtime
        [ "$qtime" -gt "$max" ] && max=$qtime
        ;;
      SERVFAIL) servfail=$((servfail + 1)) ;;
      NXDOMAIN) nxdomain=$((nxdomain + 1)) ;;
      *) timeout=$((timeout + 1)) ;;
      esac
    done

    # accumulate totals
    PROVIDER_TOTAL_MS[$p_name]=$((PROVIDER_TOTAL_MS[$p_name] + total))
    PROVIDER_TOTAL_OK[$p_name]=$((PROVIDER_TOTAL_OK[$p_name] + ok))
    PROVIDER_TOTAL_SERVFAIL[$p_name]=$((PROVIDER_TOTAL_SERVFAIL[$p_name] + servfail))
    PROVIDER_TOTAL_NX[$p_name]=$((PROVIDER_TOTAL_NX[$p_name] + nxdomain))
    PROVIDER_TOTAL_TIMEOUT[$p_name]=$((PROVIDER_TOTAL_TIMEOUT[$p_name] + timeout))

    if [ "$ok" -gt 0 ]; then
      avg=$((total / ok))
      jitter=$((max - min))
      cell=$(
        printf \
          "cold=%3sms avg=%2dms min=%2dms max=%2dms j=%2d" \
          "$cold_ms" "$avg" "$min" "$max" "$jitter"
      )
      printf " %-${COL_W}s |" "$cell"
      # printf " %-${COL_W}s |" "ok=${ok} sf=${servfail} nx=${nxdomain} to=${timeout}"
    else
      printf " %-${COL_W}s |" "timeout"
    fi
  done
  echo
done

# -----------------------------
# Ranking: average latency & success rate
# -----------------------------
echo
echo "## DNS Provider Ranking (sorted by warm avg, then cold avg)"
echo

# Column widths
W_WARM=6
W_COLD=6
W_SUCC=7
W_SF=4
W_NX=4
W_TO=4

# Header
printf "| %-*s | %*s | %*s | %*s | %*s | %*s | %*s |\n" \
  "$NAME_W" "Provider" \
  "$W_WARM" "Warm" \
  "$W_COLD" "Cold" \
  "$W_SUCC" "Success" \
  "$W_SF" "SF" \
  "$W_NX" "NX" \
  "$W_TO" "TO"

# Separator
printf "|%*s|" $((NAME_W + 2)) "" | tr ' ' '-'
printf "%*s|" $((W_WARM + 2)) "" | tr ' ' '-'
printf "%*s|" $((W_COLD + 2)) "" | tr ' ' '-'
printf "%*s|" $((W_SUCC + 2)) "" | tr ' ' '-'
printf "%*s|" $((W_SF + 2)) "" | tr ' ' '-'
printf "%*s|" $((W_NX + 2)) "" | tr ' ' '-'
printf "%*s|" $((W_TO + 2)) "" | tr ' ' '-'
echo

{
  for p in "${!PROVIDER_TOTAL_OK[@]}"; do
    [ "${PROVIDER_TOTAL_OK[$p]}" -gt 0 ] || continue
    avg_w=$((PROVIDER_TOTAL_MS[$p] / PROVIDER_TOTAL_OK[$p]))
    cold_ok=${PROVIDER_COLD_OK[$p]}
    avg_c=0
    ((cold_ok > 0)) && avg_c=$((PROVIDER_COLD_MS[$p] / cold_ok))
    success=$((100 * PROVIDER_TOTAL_OK[$p] / PROVIDER_TOTAL_Q[$p]))
    sf=${PROVIDER_TOTAL_SERVFAIL[$p]}
    nx=${PROVIDER_TOTAL_NX[$p]}
    to=${PROVIDER_TOTAL_TIMEOUT[$p]}
    echo "$avg_w $avg_c $p $success $sf $nx $to"
  done
} | sort -k4,4nr -k1,1n -k2,2n | while read -r avg_w avg_c name success sf nx to; do
  color_start="" color_end=""
  ((avg_w > WARN_LATENCY || success < WARN_SUCCESS)) && color_start="$(tput setaf 1)" && color_end="$(tput sgr0)"
  printf "| %s%-*s%s | %*dms | %*dms | %*d%% | %*d | %*d | %*d |\n" \
    "$color_start" "$NAME_W" "$name" "$color_end" \
    "$((W_WARM - 2))" "$avg_w" \
    "$((W_COLD - 2))" "$avg_c" \
    "$((W_SUCC - 1))" "$success" \
    "$W_SF" "$sf" \
    "$W_NX" "$nx" \
    "$W_TO" "$to"
done
